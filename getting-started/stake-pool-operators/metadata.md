## ステークプールメタデータ

登録証明書をブロックチェーンに送信することに加えて、委任のためにステークプールを設定するにはメタデータ（プールに関する追加情報）の準備が必要となります。

登録証明書にはプロトコルを実行するための必要なすべての情報（公開鍵のハッシュ値、コスト、マージン、リレー、出資）とともに、メタデータのハッシュ値も含まれています。

エンドユーザーのウォレットには、メタデータを提供したステークプールが表示されます。メタデータが提供されない場合、そのステークプールはプライベートと見なされ、ユーザーのウォレットには表示されません。

### パブリックステークプール

ステークプールオペレーターが送信した登録証明書にメタデータが含まれている場合、ステークプールはパブリックであるとみなされます。

ステークプール証明書は、オプションでメタデータを参照または示すことができます。証明書には、以下を含むJSONオブジェクトを示す長さ64バイトまでのURLを含むことができます。

- 3～5文字のティッカー（ウォレット用のステークプールの簡易表示）
- 最大50文字のタイトルまたは名称
- 簡単な説明文
- プールに関する追加情報が掲載されたホームページへのURL（オプション）

以下はメタデータに関する重要ポイントです。

- メタデータ情報はUTF-8エンコード使用、最大512バイト
- URLで参照されるJSONオブジェクトのcontent-hashは（適用する場合）、登録証明書のcontent-hashと一致すること。一致しない場合、プールはウォレットに表示されない
- ウォレットにプールを表示するには、以下の条件が必要 - 登録証明書がメタデータを参照しており、メタデータは有効かつ正しいcontent-hashがあり、URLで参照されていること。メタデータの取得およびその検証が可能であること。このプロセスに失敗すると、プールはウォレットに表示されない

メタデータを変更した場合、ステークプールオペレーターは新しいcontent-hashを付した新しいステークプール登録証明書を送信する必要があります。

### メタデータプロキシサーバー

ウォレットが各ステークプールから個別URLごとにメタデータを取得することはありません。これは悪質な詐欺につながる恐れがあるためです。例えば、第三者がサーバーの応答時間を故意に遅らせてウォレットの通信を遅延させることができます。このシナリオを避けるために、メタデータは登録証明書に含まれるURLに問い合わせるプロキシサーバーと'プールの秘密鍵を使用したメタデータのSKSを使用します。ウォレットは、各プールのメタデータURLにリクエストを送信する代わりに、ただこうしたプロキシサーバーに問い合わせ、表示する必要のあるプールのメタデータを取得します。証明書に記載されたcontent\_hashがキャッシュのメタデータのcontent\_hashと一致しない場合、キャッシュは無効と見なされます。

プロキシサーバーは悪質なエントリーをフィルタリングすることにより、さらにレベルの高いセキュリティを提供します。例えば、メタデータには悪質なコンテンツを埋め込むことも可能です。ステークプールのホームページへのリンクが一般的ですが、プールが危険または違法なコンテンツをホストしている場合、メタデータプロキシサーバーの管理者はそのエントリーをフィルターにかけ、ウォレットに提供しないようにすることができます。これは明らかに、チェーンに直接メタデータを書くことに比べて優れた点です。そうでなければ、ユーザーがウォレットから直接悪質なサイトを閲覧することを防ぎようがないからです。

プロキシサーバーは悪質な妨害行為に対する防波堤となる一方で、中央集権の拠り所ともなりかねません。この回避策として、第三者（ステークプール、コミュニティメンバーなど）が自身のプロキシサーバーを実行して中央集権化を避けることができるよう、コードとバイナリを提供します。

### ステークプールメタデータとの相互作用

ステークプールオペレーターは以下の手順に従ってステークプールのメタデータを登録してください。

1. ステークプールメタデータのJSONファイルを構築する

```
        {
  
          "name": "mypool",
          "description": "My stake pool",
          "ticker": "POOL1",
          "homepage": "https://mystakepool.com"
  
        }
```

注：メタデータはステークプールオペレーターが管理しているURLがホストします。これはオペレーター自身の個人的なウェブサイトやGitHubのraw gistファイルなどです。URLの長さは最大64バイトです。

2. ノードのCLIを使用してステークプールをブロックチェーンに登録または再登録する

登録情報には以下が**必要**です

- リレー情報

- メタデータのURL

- メタデータのハッシュ値

- コストのパラメーター
  
      cardano-cli shelley stake-pool registration-certificate
       --metadata-url  https://mystakepool.com/mypool.json  \  
       --metadata-hash \ 
      f97a632341f642f5ac1e15bd182d0c9599c3767230aa9bfb48b120f1c30538eb \  
      --pool-relay-port 3001 --pool-relay-ipv4 76.54.23.45 \
       ...

3. ステークプールからIDを取得する

このコードを使用してステークプールIDとプールをSMASHデータベースに登録するために必要なすべての情報を取得します

        cardano-cli shelley stake-pool id --verification-key-file pool.vkey
        > <poolid>
        

注：このコードを使用して、オンチェーンの登録が成功したかを確認できます

      cardano-cli shelley query ledger-state --testnet-magic 42 
      | jq '._delegationState._pstate._pParams.<poolid>'
      

4. [ここ](https://github.com/input-output-hk/cardano-ops/blob/master/topologies/ff-peers.nix)からPRを送信してプールのデータを追加する

IPアドレスまたはホスト名、ポートを提供する必要があります。

```
      {
         operator = "name";
         poolId = "<poolid>";
         metadataUrl = "https://yourpool.com/pool.json"
         meatadataHash = "yourpoolhash";
         addr = "relay.kevinspool.org";
         port = 3001;
      }
```

重要：IPアドレスをIOHKに登録すると「公開」されます。ファイアウォールやその他のオンラインセキュリティを実行して安全性を確保してください。
